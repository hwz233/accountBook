<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页记账本</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .card { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .balance { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"], input[type="text"], input[type="date"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #3498db; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        .log-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-item:last-child { border-bottom: none; }
        .income { color: green; font-weight: bold; }
        .expense { color: red; font-weight: bold; }
        .rate-info { background-color: #e8f6f3; padding: 15px; border-radius: 4px; border-left: 5px solid #1abc9c; }
        h1 { text-align: center; color: #333; }
        h2 { margin-top: 0; color: #555; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        .btn-center { display: block; margin: 0 auto; width: 50%; }
        .sticky-section {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f4f4f9;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="sticky-section">
        <h1 style="margin: 0; text-align: left;">我的记账本</h1>

        <!-- 1.1 Account Balance -->
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5em; font-weight: bold; color: #333;">当前余额 (SGD):</span>
            <div id="balanceDisplay" class="balance" style="font-size: 1.5em; margin: 0;">加载中...</div>
        </div>
    </div>

    <!-- 1.5 Exchange Rate -->
    <div class="card" style="margin-top: 20px;">
        <h2>实时汇率 (SGD <-> CNY)</h2>
        <div id="rateDisplay" class="rate-info">加载中...</div>
        <div style="margin-top: 20px;">
            <h3>近30天汇率走势</h3>
            <div style="width: 100%; overflow-x: auto;">
                <div style="min-width: 800px; height: 300px;">
                    <canvas id="rateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 1.2 Top-up -->
        <div class="card col">
            <h2>收入</h2>
            <div class="form-group">
                <label>金额 (新币)</label>
                <input type="number" id="topupAmount" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>原因</label>
                <input type="text" id="topupReason" placeholder="例如：工资">
            </div>
            <button class="btn-center" onclick="handleTopup()">记录</button>
        </div>

        <!-- 1.3 Expense -->
        <div class="card col">
            <h2>支出</h2>
            <div class="form-group">
                <label>金额 (新币)</label>
                <input type="number" id="expenseAmount" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>原因</label>
                <input type="text" id="expenseReason" placeholder="例如：午餐">
            </div>
            <button class="btn-center" onclick="handleExpense()">记录</button>
        </div>
    </div>

    <!-- 1.4 History -->
    <div class="card">
        <h2>历史记录</h2>
        <div class="form-group">
            <label>选择日期</label>
            <input type="date" id="historyDate" onchange="handleDateChange()">
        </div>
        <div id="historyList">
            <!-- Logs go here -->
        </div>
    </div>

    <!-- Charts -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>月度统计</h2>
            <div style="font-size: 0.9em;">
                <label style="margin-right: 15px; cursor: pointer;">
                    <input type="checkbox" id="showIncome" checked onchange="toggleStatsDataset()"> 收入图像
                </label>
                <label style="cursor: pointer;">
                    <input type="checkbox" id="showExpense" checked onchange="toggleStatsDataset()"> 支出图像
                </label>
            </div>
        </div>
        
        <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
            <label style="margin: 0;">年份:</label>
            <select id="statsYear" onchange="loadMonthlyStats()"></select>
            <label style="margin: 0;">月份:</label>
            <select id="statsMonth" onchange="loadMonthlyStats()"></select>
            <button onclick="loadMonthlyStats()" style="padding: 5px 10px;">查询</button>
        </div>

        <div style="margin-bottom: 20px;">
            <canvas id="statsChart"></canvas>
        </div>
        
        <div class="rate-info" style="border-left-color: #e74c3c; background-color: #fdedec;">
            <h3>本月最大单笔支出</h3>
            <div id="maxExpenseDisplay">
                暂无数据
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let statsChartInstance = null;
        let rateChartInstance = null;

        // Fetch Balance
        async function loadBalance() {
            try {
                const res = await fetch(`${API_URL}/balance`);
                const data = await res.json();
                if (data && data.amount !== undefined) {
                    document.getElementById('balanceDisplay').innerText = `SGD ${data.amount.toFixed(2)}`;
                } else {
                     document.getElementById('balanceDisplay').innerText = `SGD 0.00`;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('balanceDisplay').innerText = '加载余额失败';
            }
        }

        // Fetch Exchange Rate
        async function loadRate() {
            try {
                // Current Rate
                const res = await fetch(`${API_URL}/rate`);
                const data = await res.json();
                document.getElementById('rateDisplay').innerHTML = 
                    `<strong>1 SGD = ${data.CNY.toFixed(4)} CNY</strong><br><strong>1 CNY = ${data.reverseRate.toFixed(4)} SGD</strong><br><small>更新时间: ${data.timestamp}</small>`;
                
                // Historical Rate
                const histRes = await fetch(`${API_URL}/rate_history`);
                const histData = await histRes.json();
                renderRateChart(histData);

            } catch (e) {
                console.error(e);
                document.getElementById('rateDisplay').innerText = '加载汇率失败';
            }
        }

        function renderRateChart(data) {
            const ctx = document.getElementById('rateChart').getContext('2d');
            if (rateChartInstance) rateChartInstance.destroy();

            rateChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'SGD -> CNY 汇率',
                        data: data.map(d => d.rate),
                        borderColor: '#f1c40f',
                        backgroundColor: 'rgba(241, 196, 15, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Top-up
        async function handleTopup() {
            const amount = document.getElementById('topupAmount').value;
            const reason = document.getElementById('topupReason').value;
            if (!amount || !reason) return alert('请填写所有字段');

            try {
                const res = await fetch(`${API_URL}/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, reason })
                });
                if (res.ok) {
                    alert('充值成功');
                    document.getElementById('topupAmount').value = '';
                    document.getElementById('topupReason').value = '';
                    loadBalance();
                    loadHistory();
                } else {
                    alert('充值失败');
                }
            } catch (e) {
                alert('请求处理错误');
            }
        }

        // Expense
        async function handleExpense() {
            const amount = document.getElementById('expenseAmount').value;
            const reason = document.getElementById('expenseReason').value;
            if (!amount || !reason) return alert('请填写所有字段');

            try {
                const res = await fetch(`${API_URL}/expense`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, reason })
                });
                if (res.ok) {
                    alert('花销记录成功');
                    document.getElementById('expenseAmount').value = '';
                    document.getElementById('expenseReason').value = '';
                    loadBalance();
                    handleDateChange();
                } else {
                    alert('记录花销失败');
                }
            } catch (e) {
                alert('请求处理错误');
            }
        }

        function handleDateChange() {
            loadHistory();
            // loadMonthlyStats(); // Stats are now independent
        }

        // Load History
        async function loadHistory() {
            const date = document.getElementById('historyDate').value;
            if (!date) return;

            try {
                const res = await fetch(`${API_URL}/history?date=${date}`);
                const data = await res.json();
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<p>该日期没有记录。</p>';
                    return;
                }
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    const amountClass = item.type === 'income' ? 'income' : 'expense';
                    const sign = item.type === 'income' ? '+' : '-';
                    div.innerHTML = `
                        <div>
                            <span class="${amountClass}" style="font-size: 1.2em; margin-right: 10px;">${sign}${item.amount.toFixed(2)}</span>
                            <span>${item.reason}</span>
                        </div>
                        <span style="color: #888; font-size: 0.9em;">${new Date(item.date).toLocaleTimeString()}</span>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function loadMonthlyStats() {
            // Use selected year/month
            const year = document.getElementById('statsYear').value;
            const month = document.getElementById('statsMonth').value;
            
            if (!year || !month) return;

            try {
                const res = await fetch(`${API_URL}/monthly_stats?year=${year}&month=${month}`);
                const data = await res.json();
                
                renderCharts(data.income, data.expense);
                renderMaxExpense(data.max_expense);
            } catch (e) {
                console.error('Failed to load stats', e);
            }
        }

        function renderMaxExpense(maxExpense) {
            const display = document.getElementById('maxExpenseDisplay');
            if (maxExpense && maxExpense.amount > 0) {
                display.innerHTML = `
                    <p><strong>日期:</strong> ${maxExpense.date}</p>
                    <p><strong>原因:</strong> ${maxExpense.reason}</p>
                    <p><strong>金额:</strong> <span class="expense">SGD ${maxExpense.amount.toFixed(2)}</span></p>
                `;
            } else {
                display.innerHTML = '本月暂无支出记录';
            }
        }

        function renderCharts(incomeData, expenseData) {
            // Sort data by date
            incomeData.sort((a, b) => new Date(a.date) - new Date(b.date));
            expenseData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Prepare Chart Data
            const ctx = document.getElementById('statsChart').getContext('2d');

            if (statsChartInstance) statsChartInstance.destroy();

            statsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: incomeData.map(d => d.date), // Assumes income/expense dates are aligned which they are
                    datasets: [
                        {
                            label: '每日收入',
                            data: incomeData.map(d => d.amount),
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 128, 0, 0.1)',
                            tension: 0.1,
                            fill: false,
                            spanGaps: false
                        },
                        {
                            label: '每日支出',
                            data: expenseData.map(d => d.amount),
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            tension: 0.1,
                            fill: false,
                            spanGaps: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            beginAtZero: true,
                            min: 0,
                            suggestedMax: 50,
                            ticks: {
                                stepSize: 10,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true // Show default legend as well
                        }
                    }
                }
            });
            
            // Apply initial visibility based on checkboxes
            toggleStatsDataset();
        }

        function toggleStatsDataset() {
            if (!statsChartInstance) return;
            
            const showIncome = document.getElementById('showIncome').checked;
            const showExpense = document.getElementById('showExpense').checked;
            
            // Index 0 is Income, 1 is Expense
            statsChartInstance.setDatasetVisibility(0, showIncome);
            statsChartInstance.setDatasetVisibility(1, showExpense);
            
            statsChartInstance.update();
        }

        // Init
        document.getElementById('historyDate').valueAsDate = new Date();
        
        // Init Year/Month Selectors
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        
        const yearSelect = document.getElementById('statsYear');
        const monthSelect = document.getElementById('statsMonth');

        for (let y = currentYear - 5; y <= currentYear + 1; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }

        for (let m = 1; m <= 12; m++) {
            const opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            if (m === currentMonth) opt.selected = true;
            monthSelect.appendChild(opt);
        }

        loadBalance();
        loadRate();
        loadHistory(); // Only loads history for date picker
        loadMonthlyStats(); // Loads stats for selected year/month
    </script>
</body>
</html>
